// База данных данеток
const danetkiDatabase = {
    easy: [
        {
            id: 1,
            title: "Молчаливый пассажир",
            riddle: "Мужчина заходит в такси. Он говорит водителю адрес, и они едут. По пути мужчина не произносит ни слова. Водитель знает, куда ему нужно ехать. Почему?",
            solution: "Таксист был глухонемым. Мужчина показал адрес на бумажке.",
            hints: [
                "Подумайте, как можно передать информацию без слов",
                "Возможно, водитель имеет физические особенности",
                "Что, если адрес был написан?"
            ],
            difficulty: "easy",
            category: "Логические",
            estimatedTime: 5
        },
        {
            id: 2,
            title: "Смерть в пустыне",
            riddle: "Человек найден мертвым в пустыне. Рядом с ним лежит рюкзак. Что произошло?",
            solution: "Человек прыгнул с парашютом, но парашют не раскрылся. Рюкзак - это сложенный парашют.",
            hints: [
                "Подумайте, как можно оказаться в пустыне с рюкзаком",
                "Что могло быть в рюкзаке изначально?",
                "Как люди обычно попадают в удаленные места?"
            ],
            difficulty: "easy",
            category: "Загадочные",
            estimatedTime: 7
        },
        {
            id: 3,
            title: "Сломанный лифт",
            riddle: "Мужчина живет на 10-м этаже. Каждое утро он спускается на лифте на первый этаж и идет на работу. Вечером он поднимается на лифте до 7-го этажа, а дальше идет пешком. Почему?",
            solution: "Мужчина - карлик. Он достает только до кнопки 7-го этажа. Утром он может нажать на кнопку 1-го этажа, потому что там есть кнопка вызова лифта внизу.",
            hints: [
                "Подумайте о физических особенностях мужчины",
                "Почему он может нажимать кнопки только до 7-го этажа?",
                "Что изменилось бы, если бы он был выше?"
            ],
            difficulty: "easy",
            category: "Бытовые",
            estimatedTime: 6
        },
        {
            id: 4,
            title: "Странный звонок",
            riddle: "Женщина звонит в ресторан и спрашивает: 'Это ресторан У моря?'. Ей отвечают: Нет. Она вешает трубку. Через минуту она умирает. Почему?",
            solution: "Женщина заблудилась в горах и нашла убежище. Она позвонила, чтобы проверить, не вышла ли она на правильную дорогу. Услышав, что это не тот ресторан, она поняла, что заблудилась и помощи не будет. У нее было сердечное заболевание, и от отчаяния у нее случился приступ.",
            hints: [
                "Где могла находиться женщина?",
                "Почему для нее было важно, какой это ресторан?",
                "Что могло случиться после звонка?"
            ],
            difficulty: "easy",
            category: "Драматические",
            estimatedTime: 8
        },
        {
            id: 5,
            title: "Запертая комната",
            riddle: "Мужчина найден мертвым в комнате. Комната пуста, только посередине лежит лужа воды и осколки стекла. Дверь заперта изнутри. Что произошло?",
            solution: "Мужчина был аквариумистом. Он нес большой аквариум, поскользнулся на воде, упал, аквариум разбился, и его поранило стекло. Вода была из аквариума.",
            hints: [
                "Откуда взялась вода?",
                "Что могло разбиться?",
                "Почему комната была заперта изнутри?"
            ],
            difficulty: "easy",
            category: "Несчастные случаи",
            estimatedTime: 7
        }
    ],
    
    medium: [
        {
            id: 6,
            title: "Двойное убийство",
            riddle: "В доме найдены два мертвых тела. Тела лежат в луже воды, рядом разбито стекло. Что произошло?",
            solution: "Это были рыбы. Аквариум упал и разбился. Рыбы умерли без воды.",
            hints: [
                "Подумайте о нестандартных 'телах'",
                "Что могло создать лужу воды?",
                "Кто или что мог жить в стеклянном контейнере?"
            ],
            difficulty: "medium",
            category: "Нестандартные",
            estimatedTime: 10
        },
        {
            id: 7,
            title: "Странный сон",
            riddle: "Мужчине снится, что он тонет. Он просыпается от звонка телефона. Голос говорит: 'Не подходи к окну'. Мужчина подходит к окну и умирает. Почему?",
            solution: "Мужчина был космонавтом на орбитальной станции. Его сон о том, что он тонет, был на самом деле отсутствием невесомости - вода плавала в каплях. Звонок был предупреждением о разгерметизации. Когда он подошел к окну, давление выбросило его в космос.",
            hints: [
                "Где может находиться мужчина?",
                "Почему сон о воде может быть важным?",
                "Что могло случиться с окном?"
            ],
            difficulty: "medium",
            category: "Научная фантастика",
            estimatedTime: 12
        },
        {
            id: 8,
            title: "Путешествие во времени",
            riddle: "Мужчина смотрит на портрет и говорит: 'У меня нет братьев и сестер, но отец этого человека - сын моего отца'. Кто на портрете?",
            solution: "На портрете сын мужчины. 'Сын моего отца' - это сам мужчина, значит отец человека на портрете - сам мужчина.",
            hints: [
                "Разберите фразу по частям",
                "Кто такой 'сын моего отца'?",
                "Подумайте о родственных связях"
            ],
            difficulty: "medium",
            category: "Логические",
            estimatedTime: 9
        },
        {
            id: 9,
            title: "Загадочная смерть в отеле",
            riddle: "Мужчина заходит в номер отеля и вешается. Почему?",
            solution: "Мужчина был карликом. Он приехал на конкурс карликов. В номере он обнаружил, что все вещи (полотенца, кровать, умывальник) слишком высокие для него. От отчаяния он повесился, используя дверную ручку, которая была на подходящей для него высоте.",
            hints: [
                "Подумайте о физических особенностях мужчины",
                "Что могло его расстроить в номере?",
                "Почему именно повесился?"
            ],
            difficulty: "medium",
            category: "Трагические",
            estimatedTime: 11
        },
        {
            id: 10,
            title: "Исчезновение в самолете",
            riddle: "Самолет летит из Нью-Йорка в Лондон. На борту 200 пассажиров. Самолет благополучно приземляется, но когда открывают двери, все пассажиры мертвы. Что случилось?",
            solution: "Самолет был беспилотным грузовым самолетом. 'Пассажиры' были трупами, которые перевозили для медицинских исследований.",
            hints: [
                "Подумайте о типе самолета",
                "Кто такие 'пассажиры' на самом деле?",
                "Куда могли лететь 200 тел?"
            ],
            difficulty: "medium",
            category: "Детективные",
            estimatedTime: 10
        }
    ],
    
    hard: [
        {
            id: 11,
            title: "Кольцо фараона",
            riddle: "Археолог находит в гробнице фараона кольцо с надписью: 'Я был здесь до тебя и буду после'. Кто мог оставить такую надпись?",
            solution: "Это кольцо оставил предыдущий археолог. Он проник в гробницу раньше, украл сокровища, но оставил кольцо как шутку. Надпись означает, что он был там до текущего археолога и вернется после него, возможно, чтобы забрать оставшиеся ценности.",
            hints: [
                "Подумайте, кто кроме древних египтян мог оставить кольцо",
                "Что означает 'до тебя и после' в контексте времени?",
                "Кто имеет доступ к гробнице в современное время?"
            ],
            difficulty: "hard",
            category: "Археологические",
            estimatedTime: 15
        },
        {
            id: 12,
            title: "Вечный двигатель",
            riddle: "Ученый создал устройство, которое работает вечно без источника энергии. Как это возможно?",
            solution: "Устройство - это песочные часы в невесомости на космической станции. Песок плавает в невесомости, создавая иллюзию вечного движения.",
            hints: [
                "Подумайте об условиях, где нет гравитации",
                "Что может создавать иллюзию вечного движения?",
                "Где можно найти такие условия?"
            ],
            difficulty: "hard",
            category: "Научные",
            estimatedTime: 14
        },
        {
            id: 13,
            title: "Письмо из прошлого",
            riddle: "Человек получает письмо, написанное 100 лет назад, но в конверте современная марка и штемпель. Как это возможно?",
            solution: "Письмо было запечатано в капсулу времени 100 лет назад. Его нашли и отправили по почте, чтобы выполнить последнюю волю автора - письмо должно быть доставлено через 100 лет.",
            hints: [
                "Подумайте о способах сохранения писем на долгое время",
                "Кто мог найти и отправить письмо?",
                "Почему марка современная?"
            ],
            difficulty: "hard",
            category: "Исторические",
            estimatedTime: 13
        },
        {
            id: 14,
            title: "Немой свидетель",
            riddle: "В комнате три человека. Входит четвертый и убивает одного из них. Остальные двое видят убийцу, но не могут его описать. Почему?",
            solution: "Трое людей были слепоглухонемыми. Четвертый был их сиделкой, которая знала язык жестов для слепоглухонемых. Она убила одного из них, но остальные не могли ни видеть, ни слышать, ни говорить.",
            hints: [
                "Подумайте о физических ограничениях свидетелей",
                "Как можно общаться без зрения и слуха?",
                "Кто мог иметь доступ к таким людям?"
            ],
            difficulty: "hard",
            category: "Детективные",
            estimatedTime: 16
        },
        {
            id: 15,
            title: "Бессмертный",
            riddle: "Человек утверждает, что он бессмертен. Как он может это доказать?",
            solution: "Человек - последний представитель вымирающего вида. Пока он жив, вид не вымер. Его бессмертие - это метафора: он будет 'бессмертен' в памяти как последний представитель своего вида.",
            hints: [
                "Подумайте о философском значении бессмертия",
                "Что значит 'последний в своем роде'?",
                "Как можно доказать бессмертие не физическое, а символическое?"
            ],
            difficulty: "hard",
            category: "Философские",
            estimatedTime: 15
        }
    ]
};

// История игр (хранится локально)
let gameHistory = JSON.parse(localStorage.getItem('danetkiHistory')) || [];

// Статистика
let gameStats = JSON.parse(localStorage.getItem('danetkiStats')) || {
    totalPlayed: 0,
    totalSolved: 0,
    totalTime: 0,
    byDifficulty: {
        easy: { played: 0, solved: 0 },
        medium: { played: 0, solved: 0 },
        hard: { played: 0, solved: 0 }
    }
};

// Текущая игра
let currentGame = {
    difficulty: null,
    currentRiddle: null,
    startTime: null,
    questions: [],
    hintsUsed: 0,
    solved: false
};

// Функции для работы с данными
function getRandomRiddle(difficulty = 'all') {
    let availableRiddles = [];
    
    if (difficulty === 'all') {
        // Смешиваем загадки всех сложностей
        availableRiddles = [
            ...danetkiDatabase.easy,
            ...danetkiDatabase.medium,
            ...danetkiDatabase.hard
        ];
    } else {
        availableRiddles = danetkiDatabase[difficulty] || [];
    }
    
    if (availableRiddles.length === 0) {
        // Если нет загадок выбранной сложности, берем из легких
        availableRiddles = danetkiDatabase.easy;
    }
    
    // Исключаем загадки, которые уже были в этой игровой сессии
    const playedIds = gameHistory.slice(-10).map(game => game.riddleId);
    const newRiddles = availableRiddles.filter(riddle => !playedIds.includes(riddle.id));
    
    // Если есть неигранные загадки, берем случайную из них
    if (newRiddles.length > 0) {
        return newRiddles[Math.floor(Math.random() * newRiddles.length)];
    }
    
    // Иначе берем любую случайную
    return availableRiddles[Math.floor(Math.random() * availableRiddles.length)];
}

function saveGameHistory(riddle, solved, timeSpent, questionsCount, hintsUsed) {
    const gameRecord = {
        id: Date.now(),
        riddleId: riddle.id,
        title: riddle.title,
        difficulty: riddle.difficulty,
        solved: solved,
        date: new Date().toISOString(),
        timeSpent: timeSpent,
        questionsCount: questionsCount,
        hintsUsed: hintsUsed,
        riddleText: riddle.riddle,
        solution: riddle.solution
    };
    
    gameHistory.unshift(gameRecord);
    
    // Сохраняем только последние 50 игр
    if (gameHistory.length > 50) {
        gameHistory = gameHistory.slice(0, 50);
    }
    
    localStorage.setItem('danetkiHistory', JSON.stringify(gameHistory));
    
    // Обновляем статистику
    updateStats(riddle.difficulty, solved, timeSpent);
}

function updateStats(difficulty, solved, timeSpent) {
    gameStats.totalPlayed++;
    
    if (solved) {
        gameStats.totalSolved++;
    }
    
    gameStats.totalTime += Math.floor(timeSpent / 60); // В минутах
    
    if (gameStats.byDifficulty[difficulty]) {
        gameStats.byDifficulty[difficulty].played++;
        if (solved) {
            gameStats.byDifficulty[difficulty].solved++;
        }
    }
    
    localStorage.setItem('danetkiStats', JSON.stringify(gameStats));
}

function getStats() {
    return gameStats;
}

function getHistory() {
    return gameHistory;
}

function clearHistory() {
    gameHistory = [];
    localStorage.setItem('danetkiHistory', JSON.stringify(gameHistory));
}

function clearStats() {
    gameStats = {
        totalPlayed: 0,
        totalSolved: 0,
        totalTime: 0,
        byDifficulty: {
            easy: { played: 0, solved: 0 },
            medium: { played: 0, solved: 0 },
            hard: { played: 0, solved: 0 }
        }
    };
    localStorage.setItem('danetkiStats', JSON.stringify(gameStats));
}